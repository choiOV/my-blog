---
import { SITE } from "@/config";

const { giscus } = SITE;

// Giscus 비활성화 시 컴포넌트 렌더링 안 함
if (!giscus.enabled) {
  return null;
}
---

<!-- Giscus가 렌더링될 컨테이너 -->
<div class="mt-8 giscus-container" data-pagefind-ignore></div>

<script is:inline data-astro-rerun define:vars={{ giscus }}>
  function loadGiscus() {
    const container = document.querySelector('.giscus-container');
    if (!container) return;

    // 이미 로드되었는지 확인 (중복 방지)
    if (container.querySelector('.giscus, iframe.giscus-frame')) {
      console.log('[Giscus] Already loaded, syncing theme only');
      syncGiscusTheme();
      return;
    }

    // 기존 스크립트 제거 (있다면)
    const existingScript = container.querySelector('script[src*="giscus"]');
    if (existingScript) {
      existingScript.remove();
    }

    // 현재 테마 가져오기
    const theme = document.documentElement.getAttribute("data-theme");
    const giscusTheme = theme === "dark" ? "dark" : "light";

    // Giscus 스크립트 동적 생성
    const script = document.createElement('script');
    script.src = 'https://giscus.app/client.js';
    script.setAttribute('data-repo', giscus.repo);
    script.setAttribute('data-repo-id', giscus.repoId);
    script.setAttribute('data-category', giscus.category);
    script.setAttribute('data-category-id', giscus.categoryId);
    script.setAttribute('data-mapping', giscus.mapping);
    script.setAttribute('data-strict', giscus.strict);
    script.setAttribute('data-reactions-enabled', giscus.reactionsEnabled ? '1' : '0');
    script.setAttribute('data-emit-metadata', giscus.emitMetadata ? '1' : '0');
    script.setAttribute('data-input-position', giscus.inputPosition);
    script.setAttribute('data-theme', giscusTheme);
    script.setAttribute('data-lang', giscus.lang);
    script.setAttribute('data-loading', giscus.loading);
    script.crossOrigin = 'anonymous';
    script.async = true;

    container.appendChild(script);

    console.log('[Giscus] Script loaded');
  }

  function syncGiscusTheme() {
    const theme = document.documentElement.getAttribute("data-theme");
    const giscusTheme = theme === "dark" ? "dark" : "light";

    const sendMessage = (message) => {
      const iframe = document.querySelector("iframe.giscus-frame");
      if (iframe?.contentWindow) {
        iframe.contentWindow.postMessage(message, "https://giscus.app");
      }
    };

    // Giscus iframe 로드 대기
    const waitForGiscus = setInterval(() => {
      const iframe = document.querySelector("iframe.giscus-frame");
      if (iframe) {
        clearInterval(waitForGiscus);
        sendMessage({
          giscus: { setConfig: { theme: giscusTheme } },
        });
        console.log('[Giscus] Theme synced:', giscusTheme);
      }
    }, 100);

    // 10초 후 타임아웃
    setTimeout(() => clearInterval(waitForGiscus), 10000);
  }

  // 테마 변경 감지 (한 번만 등록)
  if (!window._giscusThemeObserver) {
    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (mutation.attributeName === "data-theme") {
          syncGiscusTheme();
        }
      });
    });

    observer.observe(document.documentElement, {
      attributes: true,
      attributeFilter: ["data-theme"],
    });

    window._giscusThemeObserver = observer;
  }

  // 초기 로드
  loadGiscus();

  // View Transitions 지원
  document.addEventListener("astro:after-swap", loadGiscus);
</script>
